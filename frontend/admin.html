<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SecureBank ‚Äî Admin Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --navy: #06112A; --royal: #0D2554; --blue: #1845A7; --accent: #3B82F6;
      --gold: #C9973A; --gold-light: #F1C05A; --white: #F8FAFF; --muted: #64748B;
      --text: #CBD5E1; --error: #EF4444; --success: #22C55E; --warn: #F59E0B;
      --border: rgba(59,130,246,0.15); --card: rgba(13,37,84,0.5); --sidebar-w: 250px;
    }
    body { font-family: 'DM Sans', sans-serif; background: var(--navy); color: var(--text); min-height: 100vh; display: flex; }

    /* Sidebar */
    .sidebar { width: var(--sidebar-w); background: linear-gradient(180deg, #070F2E 0%, #05091F 100%); border-right: 1px solid var(--border); display: flex; flex-direction: column; position: fixed; top: 0; left: 0; bottom: 0; z-index: 100; }
    .sidebar-logo { padding: 24px 22px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid var(--border); }
    .logo-icon { width: 38px; height: 38px; background: linear-gradient(135deg, var(--gold), var(--gold-light)); border-radius: 9px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
    .logo-name { font-family: 'Playfair Display', serif; font-size: 18px; color: var(--white); }
    .admin-badge { margin-left: auto; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--gold); background: rgba(201,151,58,0.1); border: 1px solid rgba(201,151,58,0.25); padding: 3px 8px; border-radius: 5px; }
    .sidebar-nav { flex: 1; padding: 16px 12px; display: flex; flex-direction: column; gap: 2px; }
    .nav-section-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 1.2px; color: #3D5070; padding: 14px 10px 6px; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 11px 14px; border-radius: 10px; font-size: 14px; font-weight: 500; color: #607090; cursor: pointer; transition: all 0.2s; }
    .nav-item:hover { background: rgba(59,130,246,0.08); color: var(--text); }
    .nav-item.active { background: rgba(59,130,246,0.14); color: var(--accent); }
    .nav-icon { font-size: 16px; width: 20px; text-align: center; }
    .sidebar-user { padding: 14px; border-top: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
    .user-avatar { width: 36px; height: 36px; background: linear-gradient(135deg, var(--gold), #E8A83C); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; color: white; flex-shrink: 0; }
    .user-info { flex: 1; min-width: 0; }
    .user-name { font-size: 13px; font-weight: 600; color: var(--white); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-role { font-size: 11px; color: var(--gold); }
    .logout-btn { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 16px; }
    .logout-btn:hover { color: var(--error); }

    /* Main */
    .main { margin-left: var(--sidebar-w); flex: 1; }
    .topbar { background: rgba(6,17,42,0.92); border-bottom: 1px solid var(--border); padding: 18px 32px; display: flex; align-items: center; justify-content: space-between; backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 50; }
    .page-title { font-family: 'Playfair Display', serif; font-size: 22px; color: var(--white); }
    .content { padding: 32px; }

    @keyframes slideUp { from { opacity: 0; transform: translateY(14px); } to { opacity: 1; transform: translateY(0); } }

    /* Stat cards */
    .stats-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 28px; }
    .stat-card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 20px 22px; animation: slideUp 0.4s ease forwards; opacity: 0; position: relative; overflow: hidden; }
    .stat-card::after { content: ''; position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; border-radius: 50%; background: rgba(255,255,255,0.02); }
    .stat-card:nth-child(1) { animation-delay: 0s; }
    .stat-card:nth-child(2) { animation-delay: 0.07s; }
    .stat-card:nth-child(3) { animation-delay: 0.14s; }
    .stat-card:nth-child(4) { animation-delay: 0.21s; }
    .stat-card:nth-child(5) { animation-delay: 0.28s; }
    .stat-icon { font-size: 20px; margin-bottom: 14px; }
    .stat-value { font-family: 'Playfair Display', serif; font-size: 28px; color: var(--white); margin-bottom: 4px; }
    .stat-label { font-size: 12px; color: var(--muted); }
    .stat-value.red { color: var(--error); }
    .stat-value.gold { color: var(--gold-light); }
    .stat-value.green { color: var(--success); }

    /* View panels */
    .panel-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
    .section-card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; animation: slideUp 0.5s ease forwards; opacity: 0; }
    .section-head { padding: 18px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .section-title { font-size: 16px; font-weight: 600; color: var(--white); }
    .full-width { grid-column: 1 / -1; }

    /* Access request form */
    .request-form { padding: 20px 24px; }
    .request-form label { display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: var(--muted); margin-bottom: 8px; }
    .request-form input, .request-form textarea {
      width: 100%; background: rgba(6,17,42,0.8); border: 1px solid var(--border);
      border-radius: 10px; padding: 11px 16px; font-family: 'DM Sans', sans-serif;
      font-size: 14px; color: var(--white); outline: none; margin-bottom: 14px;
      transition: border-color 0.2s;
    }
    .request-form input:focus, .request-form textarea:focus { border-color: var(--accent); }
    .request-form input::placeholder, .request-form textarea::placeholder { color: #3D5070; }
    .request-form textarea { resize: vertical; min-height: 80px; }

    .btn-primary {
      padding: 11px 22px; background: linear-gradient(135deg, var(--blue), #2563EB);
      border: none; border-radius: 10px; color: white;
      font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 600;
      cursor: pointer; transition: all 0.2s;
    }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(37,99,235,0.3); }

    /* Users table */
    .users-table { width: 100%; border-collapse: collapse; }
    .users-table thead th { padding: 12px 20px; text-align: left; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: var(--muted); background: rgba(6,17,42,0.5); border-bottom: 1px solid var(--border); }
    .users-table tbody tr { border-bottom: 1px solid rgba(59,130,246,0.06); transition: background 0.15s; animation: slideUp 0.3s ease forwards; opacity: 0; }
    .users-table tbody tr:hover { background: rgba(59,130,246,0.05); }
    .users-table td { padding: 13px 20px; font-size: 13px; }

    .status-dot { display: inline-flex; align-items: center; gap: 6px; font-size: 12px; font-weight: 600; }
    .dot { width: 7px; height: 7px; border-radius: 50%; }
    .dot.active { background: var(--success); }
    .dot.inactive { background: var(--error); }

    .btn-sm {
      padding: 6px 14px; border-radius: 7px; font-size: 12px; font-weight: 600;
      cursor: pointer; border: none; transition: all 0.2s; font-family: 'DM Sans', sans-serif;
    }
    .btn-request { background: rgba(59,130,246,0.1); color: var(--accent); border: 1px solid rgba(59,130,246,0.2); }
    .btn-request:hover { background: rgba(59,130,246,0.2); }
    .btn-toggle-on { background: rgba(239,68,68,0.1); color: var(--error); border: 1px solid rgba(239,68,68,0.2); }
    .btn-toggle-on:hover { background: rgba(239,68,68,0.2); }
    .btn-toggle-off { background: rgba(34,197,94,0.1); color: var(--success); border: 1px solid rgba(34,197,94,0.2); }
    .btn-toggle-off:hover { background: rgba(34,197,94,0.2); }

    /* Flagged transactions */
    .flagged-list { padding: 8px 0; }
    .flagged-item { display: flex; align-items: center; padding: 13px 24px; gap: 14px; border-bottom: 1px solid rgba(59,130,246,0.06); transition: background 0.15s; }
    .flagged-item:last-child { border-bottom: none; }
    .flagged-item:hover { background: rgba(245,158,11,0.04); }
    .flag-icon { width: 36px; height: 36px; background: rgba(245,158,11,0.1); border-radius: 9px; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; }
    .flag-info { flex: 1; min-width: 0; }
    .flag-user { font-size: 13px; font-weight: 600; color: var(--white); }
    .flag-desc { font-size: 12px; color: var(--muted); margin-top: 2px; }
    .flag-amount { font-size: 14px; font-weight: 700; color: var(--error); }

    /* Audit logs */
    .audit-list { max-height: 340px; overflow-y: auto; }
    .audit-item { display: flex; align-items: flex-start; padding: 12px 24px; gap: 12px; border-bottom: 1px solid rgba(59,130,246,0.06); }
    .audit-item:last-child { border-bottom: none; }
    .audit-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); margin-top: 5px; flex-shrink: 0; }
    .audit-dot.admin { background: var(--gold); }
    .audit-dot.user { background: var(--accent); }
    .audit-action { font-size: 13px; color: var(--white); font-weight: 500; }
    .audit-meta { font-size: 12px; color: var(--muted); margin-top: 2px; }

    /* Pagination */
    .pag-row { display: flex; align-items: center; justify-content: space-between; padding: 14px 20px; border-top: 1px solid var(--border); }
    .pag-info { font-size: 12px; color: var(--muted); }
    .pag-btns { display: flex; gap: 6px; }
    .pag-btn { padding: 6px 14px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 7px; color: var(--text); font-size: 12px; cursor: pointer; transition: all 0.15s; }
    .pag-btn:hover:not(:disabled) { background: rgba(59,130,246,0.15); border-color: var(--accent); }
    .pag-btn:disabled { opacity: 0.3; cursor: not-allowed; }

    /* Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.72); backdrop-filter: blur(4px); z-index: 200; display: none; align-items: center; justify-content: center; }
    .modal-overlay.open { display: flex; }
    .modal { background: #0A1E4A; border: 1px solid var(--border); border-radius: 18px; padding: 36px; width: 440px; animation: modalIn 0.3s ease; }
    @keyframes modalIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    .modal h3 { font-family: 'Playfair Display', serif; font-size: 22px; color: var(--white); margin-bottom: 6px; }
    .modal-sub { font-size: 13px; color: var(--muted); margin-bottom: 22px; }
    .modal label { display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: var(--muted); margin-bottom: 8px; }
    .modal input, .modal textarea { width: 100%; background: rgba(255,255,255,0.04); border: 1px solid var(--border); border-radius: 10px; padding: 11px 16px; font-family: 'DM Sans', sans-serif; font-size: 14px; color: var(--white); outline: none; margin-bottom: 16px; transition: border-color 0.2s; }
    .modal textarea { resize: vertical; min-height: 90px; }
    .modal input:focus, .modal textarea:focus { border-color: var(--accent); }
    .modal input::placeholder, .modal textarea::placeholder { color: #3D5070; }
    .modal-actions { display: flex; gap: 12px; }
    .btn-cancel { flex: 1; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 14px; cursor: pointer; }
    .btn-cancel:hover { background: rgba(255,255,255,0.09); }
    .btn-confirm { flex: 2; padding: 12px; background: linear-gradient(135deg, var(--blue), #2563EB); border: none; border-radius: 10px; color: white; font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .btn-confirm:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(37,99,235,0.3); }

    .toast { position: fixed; top: 24px; right: 24px; padding: 14px 20px; border-radius: 10px; font-size: 14px; font-weight: 500; z-index: 999; transform: translateX(120%); transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); max-width: 340px; }
    .toast.show { transform: translateX(0); }
    .toast.success { background: #052E16; border: 1px solid #166534; color: #86EFAC; }
    .toast.error { background: #2A0A0A; border: 1px solid #7F1D1D; color: #FCA5A5; }

    .empty-state { padding: 50px 20px; text-align: center; color: var(--muted); font-size: 14px; }
    .view-all { font-size: 12px; color: var(--accent); cursor: pointer; }
  </style>
</head>
<body>

<div class="toast" id="toast"></div>

<!-- Access Request Modal -->
<div class="modal-overlay" id="reqModal">
  <div class="modal">
    <h3>üîê Request Account Access</h3>
    <p class="modal-sub">User will be notified and must approve before you can view their account.</p>
    <input type="hidden" id="modal-user-id"/>
    <label>User</label>
    <input type="text" id="modal-user-name" readonly style="opacity:0.7;"/>
    <label>Reason for Access <span style="color:var(--error)">*</span></label>
    <textarea id="modal-reason" placeholder="e.g., Investigating disputed transaction reported by the user on 15 Jan 2025. Need to review last 10 transactions."></textarea>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal()">Cancel</button>
      <button class="btn-confirm" onclick="sendAccessRequest()">Send Request</button>
    </div>
  </div>
</div>

<!-- Account Viewer Modal -->
<div class="modal-overlay" id="accountModal">
  <div class="modal" style="width:580px; max-height:85vh; overflow-y:auto;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
      <h3 id="accountModalTitle">Account Details</h3>
      <button onclick="closeAccountModal()" style="background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer;">‚úï</button>
    </div>
    <p class="modal-sub">Viewing with granted permission token</p>
    <div id="accountModalBody">Loading...</div>
  </div>
</div>

<!-- Sidebar -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <div class="logo-icon">üè¶</div>
    <span class="logo-name">SecureBank</span>
    <span class="admin-badge">Admin</span>
  </div>
  <nav class="sidebar-nav">
    <div class="nav-section-label">Overview</div>
    <div class="nav-item active" onclick="showSection('overview')"><span class="nav-icon">üìä</span> Dashboard</div>
    <div class="nav-item" onclick="showSection('users')"><span class="nav-icon">üë•</span> Users</div>
    <div class="nav-section-label">Security</div>
    <div class="nav-item" onclick="showSection('myrequests')"><span class="nav-icon">üîê</span> My Access Requests</div>
    <div class="nav-item" onclick="showSection('flagged')"><span class="nav-icon">‚ö†Ô∏è</span> Flagged Transactions</div>
    <div class="nav-item" onclick="showSection('audit')"><span class="nav-icon">üìù</span> Audit Logs</div>
  </nav>
  <div class="sidebar-user">
    <div class="user-avatar" id="avatarLetter">A</div>
    <div class="user-info">
      <div class="user-name" id="adminName">Admin</div>
      <div class="user-role">Bank Administrator</div>
    </div>
    <button class="logout-btn" onclick="logout()">‚èª</button>
  </div>
</aside>

<!-- Main -->
<main class="main">
  <div class="topbar">
    <div class="page-title" id="topbarTitle">Admin Dashboard</div>
    <div style="font-size:13px; color:var(--muted); display:flex; align-items:center; gap:8px;">
      <div style="width:8px; height:8px; background:var(--success); border-radius:50%; animation:pulse 2s infinite;"></div>
      System Online
    </div>
  </div>

  <div class="content">

    <!-- OVERVIEW SECTION -->
    <div id="sec-overview">
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-icon">üë•</div><div class="stat-value" id="s-users">‚Äì</div><div class="stat-label">Total Users</div></div>
        <div class="stat-card"><div class="stat-icon">üìã</div><div class="stat-value" id="s-txns">‚Äì</div><div class="stat-label">Total Transactions</div></div>
        <div class="stat-card"><div class="stat-icon">‚ö†Ô∏è</div><div class="stat-value red" id="s-flagged">‚Äì</div><div class="stat-label">Flagged Transactions</div></div>
        <div class="stat-card"><div class="stat-icon">üìÖ</div><div class="stat-value green" id="s-today">‚Äì</div><div class="stat-label">Today's Transactions</div></div>
        <div class="stat-card"><div class="stat-icon">üîê</div><div class="stat-value gold" id="s-pending">‚Äì</div><div class="stat-label">Pending Access Req.</div></div>
      </div>

      <div class="panel-row">
        <!-- Quick access request form -->
        <div class="section-card">
          <div class="section-head"><span class="section-title">üîê Request Account Access</span></div>
          <div class="request-form">
            <p style="font-size:13px; color:var(--muted); margin-bottom:18px; line-height:1.6;">
              Enter a user's account number. They will receive an email notification and must <strong>explicitly grant permission</strong> before you can view their account.
            </p>
            <label>User Account Number</label>
            <input type="text" id="req-account" placeholder="e.g., ACC1234567890"/>
            <label>Reason for Access <span style="color:var(--error)">*</span></label>
            <textarea id="req-reason" placeholder="Describe why you need access..."></textarea>
            <button class="btn-primary" onclick="quickRequestAccess()">üì® Send Access Request</button>
          </div>
        </div>

        <!-- Recent flagged transactions -->
        <div class="section-card">
          <div class="section-head">
            <span class="section-title">‚ö†Ô∏è Flagged Transactions</span>
            <span class="view-all" onclick="showSection('flagged')">View all ‚Üí</span>
          </div>
          <div class="flagged-list" id="recentFlagged">
            <div class="empty-state">Loading...</div>
          </div>
        </div>
      </div>

      <!-- Audit logs preview -->
      <div class="section-card full-width">
        <div class="section-head">
          <span class="section-title">üìù Recent Audit Logs</span>
          <span class="view-all" onclick="showSection('audit')">View all ‚Üí</span>
        </div>
        <div class="audit-list" id="recentAudit">
          <div class="empty-state">Loading...</div>
        </div>
      </div>
    </div>

    <!-- USERS SECTION -->
    <div id="sec-users" style="display:none;">
      <div class="section-card">
        <div class="section-head">
          <span class="section-title">üë• All Users</span>
          <span style="font-size:13px; color:var(--muted);" id="userCount"></span>
        </div>
        <div style="overflow-x:auto;">
          <table class="users-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Account No.</th>
                <th>Balance</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="usersBody">
              <tr><td colspan="6"><div class="empty-state">Loading...</div></td></tr>
            </tbody>
          </table>
        </div>
        <div class="pag-row">
          <span class="pag-info" id="usersPagInfo"></span>
          <div class="pag-btns" id="usersPagBtns"></div>
        </div>
      </div>
    </div>

    <!-- FLAGGED SECTION -->
    <div id="sec-flagged" style="display:none;">
      <div class="section-card">
        <div class="section-head"><span class="section-title">‚ö†Ô∏è All Flagged Transactions</span></div>
        <div class="flagged-list" id="allFlagged">
          <div class="empty-state">Loading...</div>
        </div>
      </div>
    </div>

    <!-- MY REQUESTS SECTION -->
    <div id="sec-myrequests" style="display:none;">
      <div class="section-card">
        <div class="section-head">
          <span class="section-title">üîê My Access Requests</span>
          <button onclick="loadMyRequests()" style="background:rgba(59,130,246,0.1);border:1px solid var(--border);border-radius:8px;padding:6px 14px;color:var(--accent);font-size:13px;cursor:pointer;">üîÑ Refresh</button>
        </div>
        <div id="myRequestsList"><div class="empty-state">Loading...</div></div>
      </div>
    </div>

    <!-- AUDIT SECTION -->
    <div id="sec-audit" style="display:none;">
      <div class="section-card">
        <div class="section-head">
          <span class="section-title">üìù System Audit Logs</span>
          <span style="font-size:12px; color:var(--muted);">Complete activity trail</span>
        </div>
        <div class="audit-list" id="allAudit" style="max-height:none;">
          <div class="empty-state">Loading...</div>
        </div>
        <div class="pag-row">
          <span class="pag-info" id="auditPagInfo"></span>
          <div class="pag-btns" id="auditPagBtns"></div>
        </div>
      </div>
    </div>

  </div>
</main>

<script>
  const API = window.location.origin + '/api/v1';
  const token = localStorage.getItem('token');
  const role = localStorage.getItem('role');
  if (!token || role !== 'admin') window.location.href = '/login';

  const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` };

  document.getElementById('adminName').textContent = localStorage.getItem('name') || 'Admin';
  document.getElementById('avatarLetter').textContent = (localStorage.getItem('name') || 'A')[0].toUpperCase();

  function showToast(msg, type = 'success') {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = `toast ${type} show`;
    setTimeout(() => t.classList.remove('show'), 4000);
  }

  function logout() { localStorage.clear(); window.location.href = '/login'; }

  function formatCurrency(n) { return Number(n).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
  function formatDate(d) { return new Date(d).toLocaleString('en-IN', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }); }

  function showSection(name) {
    ['overview', 'users', 'flagged', 'audit', 'myrequests'].forEach(s => {
      const el = document.getElementById(`sec-${s}`);
      if (el) el.style.display = s === name ? '' : 'none';
    });
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    event.currentTarget.classList.add('active');

    const titles = { overview: 'Admin Dashboard', users: 'Users Management', flagged: 'Flagged Transactions', audit: 'Audit Logs', myrequests: 'My Access Requests' };
    document.getElementById('topbarTitle').textContent = titles[name] || name;

    if (name === 'users') loadUsers();
    if (name === 'flagged') loadAllFlagged();
    if (name === 'audit') loadAuditLogs();
    if (name === 'myrequests') loadMyRequests();
  }

  function closeModal() { document.getElementById('reqModal').classList.remove('open'); }
  function closeAccountModal() { document.getElementById('accountModal').classList.remove('open'); }

  // MY REQUESTS
  async function loadMyRequests() {
    const el = document.getElementById('myRequestsList');
    el.innerHTML = '<div class="empty-state">Loading...</div>';
    try {
      const res = await fetch(`${API}/admin/my-requests`, { headers });
      const data = await res.json();

      if (!data.requests.length) {
        el.innerHTML = '<div class="empty-state">You have not sent any access requests yet.</div>';
        return;
      }

      el.innerHTML = data.requests.map(r => {
        const statusColors = { pending: '#F59E0B', granted: '#22C55E', denied: '#EF4444', expired: '#64748B' };
        const statusIcons  = { pending: '‚è≥', granted: '‚úÖ', denied: '‚ùå', expired: '‚åõ' };
        const color = statusColors[r.status] || '#64748B';
        const icon  = statusIcons[r.status]  || '?';
        const viewBtn = r.status === 'granted' && r.permission_token
          ? `<button class="btn-sm btn-request" onclick="viewUserAccount('${r.user_id}','${r.permission_token}','${r.user_name}')">üëÅ View Account</button>`
          : '';
        const statusMsg = {
          pending: '<div style="font-size:12px;color:#F59E0B;margin-top:4px;">‚è≥ Waiting for user to respond...</div>',
          granted: '<div style="font-size:12px;color:#22C55E;margin-top:4px;">‚úÖ User granted access! Click "View Account" to see their details.</div>',
          denied:  '<div style="font-size:12px;color:#EF4444;margin-top:4px;">‚ùå User denied your request.</div>',
          expired: '<div style="font-size:12px;color:#64748B;margin-top:4px;">‚åõ Request expired. Send a new request if needed.</div>'
        }[r.status] || '';

        return `
          <div style="display:flex;align-items:flex-start;padding:18px 24px;gap:16px;border-bottom:1px solid rgba(59,130,246,0.07);">
            <div style="width:44px;height:44px;border-radius:10px;background:${color}18;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;">${icon}</div>
            <div style="flex:1;">
              <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;flex-wrap:wrap;">
                <span style="font-size:15px;font-weight:600;color:var(--white);">${r.user_name}</span>
                <span style="font-size:11px;font-family:monospace;color:var(--accent);">${r.account_number}</span>
                <span style="font-size:11px;font-weight:700;color:${color};background:${color}15;padding:2px 10px;border-radius:20px;border:1px solid ${color}30;">${icon} ${r.status.toUpperCase()}</span>
              </div>
              <div style="font-size:13px;color:var(--muted);margin-bottom:6px;">Reason: "${r.reason}"</div>
              <div style="font-size:12px;color:#3D5070;">Requested: ${formatDate(r.requested_at)}${r.granted_at ? ' ¬∑ Granted: ' + formatDate(r.granted_at) : ''}</div>
              ${statusMsg}
            </div>
            <div style="flex-shrink:0;">${viewBtn}</div>
          </div>`;
      }).join('');
    } catch(e) {
      el.innerHTML = '<div class="empty-state">Failed to load requests</div>';
    }
  }

  // VIEW USER ACCOUNT WITH PERMISSION TOKEN
  async function viewUserAccount(userId, permissionToken, userName) {
    try {
      const res = await fetch(`${API}/admin/user-account/${userId}`, {
        headers: { ...headers, 'X-Permission-Token': permissionToken }
      });
      const data = await res.json();

      if (!res.ok) {
        showToast(data.error || 'Access denied or token expired', 'error');
        return;
      }

      const u = data.user;
      const txns = data.transactions;

      document.getElementById('accountModalTitle').textContent = `üë§ ${userName}\'s Account`;
      document.getElementById('accountModalBody').innerHTML = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px;">
          <div style="background:rgba(6,17,42,0.7);border:1px solid var(--border);border-radius:10px;padding:16px;">
            <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:6px;">Balance</div>
            <div style="font-family:'Playfair Display',serif;font-size:26px;color:var(--white);">‚Çπ${formatCurrency(u.balance)}</div>
          </div>
          <div style="background:rgba(6,17,42,0.7);border:1px solid var(--border);border-radius:10px;padding:16px;">
            <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:6px;">Account Info</div>
            <div style="font-size:13px;font-family:monospace;color:var(--accent);">${u.account_number}</div>
            <div style="font-size:12px;color:var(--muted);margin-top:4px;">${u.email}</div>
          </div>
        </div>
        <div style="font-size:13px;font-weight:600;color:var(--white);margin-bottom:10px;">Recent Transactions</div>
        <div style="max-height:280px;overflow-y:auto;">
          ${txns.length === 0 ? '<div style="text-align:center;color:var(--muted);padding:20px;">No transactions found</div>' :
          txns.map(t => `
            <div style="display:flex;align-items:center;padding:10px 14px;border-radius:8px;margin-bottom:6px;background:rgba(6,17,42,0.5);gap:12px;">
              <span style="font-size:18px;">${t.type === 'credit' ? 'üì•' : t.is_flagged ? '‚ö†Ô∏è' : 'üì§'}</span>
              <div style="flex:1;">
                <div style="font-size:13px;color:var(--white);font-weight:500;">${t.description || t.type}</div>
                <div style="font-size:11px;color:var(--muted);">${formatDate(t.timestamp)}</div>
              </div>
              <div style="font-size:14px;font-weight:700;color:${t.type === 'credit' ? 'var(--success)' : 'var(--error)'};">
                ${t.type === 'credit' ? '+' : '-'}‚Çπ${formatCurrency(t.amount)}
              </div>
            </div>`).join('')}
        </div>
        <div style="margin-top:14px;padding:10px 14px;background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.2);border-radius:8px;font-size:12px;color:var(--warn);">
          ‚ö†Ô∏è This access is logged in the audit trail. Token expires 30 minutes after user approval.
        </div>`;

      document.getElementById('accountModal').classList.add('open');
    } catch(e) {
      showToast('Failed to load account details', 'error');
    }
  }

  async function loadDashboard() {
    try {
      const res = await fetch(`${API}/admin/dashboard`, { headers });
      const data = await res.json();
      document.getElementById('s-users').textContent = data.total_users;
      document.getElementById('s-txns').textContent = data.total_transactions;
      document.getElementById('s-flagged').textContent = data.flagged_transactions;
      document.getElementById('s-today').textContent = data.today_transactions;
      document.getElementById('s-pending').textContent = data.pending_access_requests;
    } catch(e) {}
  }

  async function loadRecentFlagged() {
    try {
      const res = await fetch(`${API}/admin/flagged-transactions`, { headers });
      const data = await res.json();
      const el = document.getElementById('recentFlagged');
      const items = data.flagged_transactions.slice(0, 4);
      if (!items.length) { el.innerHTML = '<div class="empty-state">‚úÖ No flagged transactions</div>'; return; }
      el.innerHTML = items.map(t => `
        <div class="flagged-item">
          <div class="flag-icon">‚ö†Ô∏è</div>
          <div class="flag-info">
            <div class="flag-user">${t.user_name} ¬∑ ${t.account_number}</div>
            <div class="flag-desc">${t.type.toUpperCase()} ¬∑ Score: ${(t.fraud_score * 100).toFixed(0)}% ¬∑ ${formatDate(t.timestamp)}</div>
          </div>
          <div class="flag-amount">‚Çπ${formatCurrency(t.amount)}</div>
        </div>`).join('');
    } catch(e) {}
  }

  async function loadRecentAudit() {
    try {
      const res = await fetch(`${API}/admin/audit-logs?limit=8`, { headers });
      const data = await res.json();
      const el = document.getElementById('recentAudit');
      if (!data.logs.length) { el.innerHTML = '<div class="empty-state">No audit logs yet</div>'; return; }
      el.innerHTML = data.logs.map(log => `
        <div class="audit-item">
          <div class="audit-dot ${log.actor_role}"></div>
          <div>
            <div class="audit-action">${log.action.replace(/_/g, ' ')} <span style="color:var(--muted);">by ${log.actor_role}</span></div>
            <div class="audit-meta">${formatDate(log.timestamp)} ¬∑ IP: ${log.ip_address || 'unknown'}</div>
          </div>
        </div>`).join('');
    } catch(e) {}
  }

  let usersPage = 1;

  async function loadUsers(page = 1) {
    usersPage = page;
    try {
      const res = await fetch(`${API}/admin/users?page=${page}&limit=10`, { headers });
      const data = await res.json();
      document.getElementById('userCount').textContent = `${data.total} total users`;

      const tbody = document.getElementById('usersBody');
      if (!data.users.length) { tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state">No users</div></td></tr>'; return; }

      tbody.innerHTML = data.users.map((u, i) => `
        <tr style="animation-delay:${i * 0.04}s">
          <td style="color:var(--white); font-weight:500;">${u.name}</td>
          <td style="color:var(--muted);">${u.email}</td>
          <td style="font-family:monospace; color:var(--accent); font-size:12px;">${u.account_number}</td>
          <td style="font-weight:600; color:var(--white);">‚Çπ${formatCurrency(u.balance)}</td>
          <td>
            <span class="status-dot">
              <div class="dot ${u.is_active ? 'active' : 'inactive'}"></div>
              ${u.is_active ? 'Active' : 'Inactive'}
            </span>
          </td>
          <td>
            <div style="display:flex; gap:8px;">
              <button class="btn-sm btn-request" onclick="openRequestModal('${u.user_id}','${u.name}')">üîê Request Access</button>
              <button class="btn-sm ${u.is_active ? 'btn-toggle-on' : 'btn-toggle-off'}" onclick="toggleAccount('${u.user_id}', this, '${u.name}')">
                ${u.is_active ? 'üîí Deactivate' : '‚úÖ Activate'}
              </button>
            </div>
          </td>
        </tr>`).join('');

      // Pagination
      const info = document.getElementById('usersPagInfo');
      const btns = document.getElementById('usersPagBtns');
      info.textContent = `Page ${data.page} of ${data.pages}`;
      btns.innerHTML = `
        <button class="pag-btn" onclick="loadUsers(${data.page-1})" ${data.page === 1 ? 'disabled' : ''}>‚Üê Prev</button>
        <button class="pag-btn" onclick="loadUsers(${data.page+1})" ${data.page === data.pages ? 'disabled' : ''}>Next ‚Üí</button>`;
    } catch(e) { showToast('Failed to load users', 'error'); }
  }

  function openRequestModal(userId, userName) {
    document.getElementById('modal-user-id').value = userId;
    document.getElementById('modal-user-name').value = userName;
    document.getElementById('modal-reason').value = '';
    document.getElementById('reqModal').classList.add('open');
  }

  async function sendAccessRequest() {
    const userId = document.getElementById('modal-user-id').value;
    const reason = document.getElementById('modal-reason').value.trim();
    if (!reason || reason.length < 10) { showToast('Please provide a detailed reason (min 10 chars)', 'error'); return; }

    try {
      const res = await fetch(`${API}/admin/request-access/${userId}`, {
        method: 'POST', headers,
        body: JSON.stringify({ reason })
      });
      const data = await res.json();
      if (res.ok) {
        showToast('‚úÖ Access request sent! User will be notified by email.');
        closeModal();
      } else {
        showToast(data.error, 'error');
      }
    } catch(e) { showToast('Request failed', 'error'); }
  }

  async function quickRequestAccess() {
    const account = document.getElementById('req-account').value.trim();
    const reason = document.getElementById('req-reason').value.trim();

    if (!account) { showToast('Enter user account number', 'error'); return; }
    if (!reason || reason.length < 10) { showToast('Provide a detailed reason (min 10 chars)', 'error'); return; }

    // Find user by account number
    try {
      const usersRes = await fetch(`${API}/admin/users?limit=100`, { headers });
      const usersData = await usersRes.json();
      const user = usersData.users.find(u => u.account_number === account);

      if (!user) { showToast('User account not found', 'error'); return; }

      const res = await fetch(`${API}/admin/request-access/${user.user_id}`, {
        method: 'POST', headers,
        body: JSON.stringify({ reason })
      });
      const data = await res.json();
      if (res.ok) {
        showToast(`‚úÖ Request sent to ${user.name}. Awaiting their approval.`);
        document.getElementById('req-account').value = '';
        document.getElementById('req-reason').value = '';
      } else {
        showToast(data.error, 'error');
      }
    } catch(e) { showToast('Request failed', 'error'); }
  }

  async function toggleAccount(userId, btn, name) {
    try {
      const res = await fetch(`${API}/admin/toggle-account/${userId}`, { method: 'POST', headers });
      const data = await res.json();
      if (res.ok) {
        showToast(data.message);
        loadUsers(usersPage);
      } else {
        showToast(data.error, 'error');
      }
    } catch(e) { showToast('Failed to update account', 'error'); }
  }

  async function loadAllFlagged() {
    try {
      const res = await fetch(`${API}/admin/flagged-transactions`, { headers });
      const data = await res.json();
      const el = document.getElementById('allFlagged');
      if (!data.flagged_transactions.length) { el.innerHTML = '<div class="empty-state">‚úÖ No flagged transactions</div>'; return; }
      el.innerHTML = data.flagged_transactions.map(t => `
        <div class="flagged-item">
          <div class="flag-icon">‚ö†Ô∏è</div>
          <div class="flag-info">
            <div class="flag-user">${t.user_name} ¬∑ <span style="font-family:monospace; font-size:12px; color:var(--accent);">${t.account_number}</span></div>
            <div class="flag-desc">${t.type.toUpperCase()} ¬∑ Fraud Score: <span style="color:var(--error)">${(t.fraud_score * 100).toFixed(0)}%</span> ¬∑ ${formatDate(t.timestamp)}</div>
          </div>
          <div class="flag-amount">‚Çπ${formatCurrency(t.amount)}</div>
        </div>`).join('');
    } catch(e) { showToast('Failed to load', 'error'); }
  }

  let auditPage = 1;
  async function loadAuditLogs(page = 1) {
    auditPage = page;
    try {
      const res = await fetch(`${API}/admin/audit-logs?page=${page}&limit=20`, { headers });
      const data = await res.json();
      const el = document.getElementById('allAudit');
      if (!data.logs.length) { el.innerHTML = '<div class="empty-state">No logs</div>'; return; }
      el.innerHTML = data.logs.map(log => `
        <div class="audit-item">
          <div class="audit-dot ${log.actor_role}"></div>
          <div style="flex:1;">
            <div class="audit-action">
              <span style="text-transform:capitalize; font-weight:600;">${log.action.replace(/_/g,' ')}</span>
              <span style="color:var(--muted); font-weight:400;"> by <em>${log.actor_role}</em></span>
              ${log.target_user_id ? `<span style="color:var(--muted);"> ¬∑ target: ${log.target_user_id.slice(-6)}</span>` : ''}
            </div>
            <div class="audit-meta">${formatDate(log.timestamp)} ¬∑ IP: ${log.ip_address || 'n/a'} ¬∑ ${log.details && Object.keys(log.details).length ? JSON.stringify(log.details).slice(0,80) : ''}</div>
          </div>
        </div>`).join('');

      document.getElementById('auditPagInfo').textContent = `Page ${data.page} of ${Math.ceil(data.total / 20)}`;
      document.getElementById('auditPagBtns').innerHTML = `
        <button class="pag-btn" onclick="loadAuditLogs(${page-1})" ${page === 1 ? 'disabled' : ''}>‚Üê Prev</button>
        <button class="pag-btn" onclick="loadAuditLogs(${page+1})" ${data.logs.length < 20 ? 'disabled' : ''}>Next ‚Üí</button>`;
    } catch(e) {}
  }

  document.getElementById('reqModal').addEventListener('click', e => {
    if (e.target === document.getElementById('reqModal')) closeModal();
  });

  // Init
  loadDashboard();
  loadRecentFlagged();
  loadRecentAudit();
</script>
</body>
</html>
