<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SecureBank ‚Äî Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --navy: #06112A;
      --royal: #0D2554;
      --blue: #1845A7;
      --accent: #3B82F6;
      --gold: #C9973A;
      --gold-light: #F1C05A;
      --white: #F8FAFF;
      --muted: #64748B;
      --text: #CBD5E1;
      --error: #EF4444;
      --success: #22C55E;
      --border: rgba(59,130,246,0.15);
      --card: rgba(13,37,84,0.5);
      --sidebar-w: 240px;
    }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--navy);
      color: var(--text);
      min-height: 100vh;
      display: flex;
    }

    /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
    .sidebar {
      width: var(--sidebar-w);
      background: linear-gradient(180deg, #08173F 0%, #060F29 100%);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      position: fixed;
      top: 0; left: 0; bottom: 0;
      z-index: 100;
    }

    .sidebar-logo {
      padding: 28px 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 1px solid var(--border);
    }

    .logo-icon {
      width: 38px; height: 38px;
      background: linear-gradient(135deg, var(--gold), var(--gold-light));
      border-radius: 9px;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px;
    }

    .logo-name {
      font-family: 'Playfair Display', serif;
      font-size: 18px;
      color: var(--white);
    }

    .sidebar-nav {
      flex: 1;
      padding: 20px 14px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      overflow-y: auto;
      overflow-x: hidden;
      scrollbar-width: thin;
      scrollbar-color: rgba(59,130,246,0.2) transparent;
    }
    .sidebar-nav::-webkit-scrollbar { width: 4px; }
    .sidebar-nav::-webkit-scrollbar-track { background: transparent; }
    .sidebar-nav::-webkit-scrollbar-thumb { background: rgba(59,130,246,0.2); border-radius: 4px; }

    .nav-section-label {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      color: #3D5070;
      padding: 14px 10px 8px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 11px 14px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      color: #607090;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
    }

    .nav-item:hover { background: rgba(59,130,246,0.08); color: var(--text); }
    .nav-item.active { background: rgba(59,130,246,0.14); color: var(--accent); }

    .nav-icon { font-size: 17px; width: 20px; text-align: center; }

    .sidebar-user {
      padding: 16px;
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 38px; height: 38px;
      background: linear-gradient(135deg, var(--blue), var(--accent));
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 15px; font-weight: 700; color: white;
      flex-shrink: 0;
    }

    .user-info { flex: 1; min-width: 0; }
    .user-name { font-size: 13px; font-weight: 600; color: var(--white); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-role { font-size: 11px; color: var(--muted); }

    .logout-btn {
      background: none; border: none; color: var(--muted); cursor: pointer; font-size: 16px;
      padding: 4px; border-radius: 6px; transition: color 0.2s;
    }
    .logout-btn:hover { color: var(--error); }

    /* ‚îÄ‚îÄ MAIN CONTENT ‚îÄ‚îÄ */
    .main {
      margin-left: var(--sidebar-w);
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .topbar {
      background: rgba(6,17,42,0.9);
      border-bottom: 1px solid var(--border);
      padding: 18px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      backdrop-filter: blur(10px);
      position: sticky; top: 0; z-index: 50;
    }

    .page-title {
      font-family: 'Playfair Display', serif;
      font-size: 22px;
      color: var(--white);
    }

    .topbar-right { display: flex; align-items: center; gap: 16px; }

    .alert-badge {
      position: relative;
      background: rgba(59,130,246,0.1);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 14px;
      font-size: 13px;
      color: var(--text);
      cursor: pointer;
      display: flex; align-items: center; gap: 8px;
    }

    .badge-dot {
      width: 8px; height: 8px;
      background: var(--gold);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(0.85); }
    }

    .content {
      padding: 32px;
      flex: 1;
    }

    /* ‚îÄ‚îÄ BALANCE CARD ‚îÄ‚îÄ */
    .balance-card {
      background: linear-gradient(135deg, #0D2554 0%, #1845A7 60%, #1D3A8A 100%);
      border-radius: 20px;
      padding: 36px 40px;
      margin-bottom: 28px;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(59,130,246,0.25);
      animation: slideUp 0.5s ease forwards;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(16px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .balance-card::before {
      content: '';
      position: absolute;
      top: -60px; right: -40px;
      width: 240px; height: 240px;
      border-radius: 50%;
      background: rgba(255,255,255,0.04);
    }

    .balance-card::after {
      content: '';
      position: absolute;
      bottom: -80px; right: 80px;
      width: 200px; height: 200px;
      border-radius: 50%;
      background: rgba(201,151,58,0.07);
    }

    .balance-top { display: flex; justify-content: space-between; align-items: flex-start; }

    .balance-label {
      font-size: 13px;
      font-weight: 500;
      color: rgba(248,250,255,0.6);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
    }

    .balance-amount {
      font-family: 'Playfair Display', serif;
      font-size: 48px;
      color: var(--white);
      line-height: 1;
      margin-bottom: 8px;
    }

    .balance-sub { font-size: 13px; color: rgba(248,250,255,0.5); }
    .acct-number { font-size: 14px; color: rgba(248,250,255,0.7); letter-spacing: 2px; margin-top: 24px; }

    .balance-actions {
      display: flex;
      gap: 12px;
      margin-top: 28px;
    }

    .btn-action {
      padding: 11px 22px;
      border-radius: 10px;
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }

    .btn-white {
      background: white;
      color: var(--blue);
    }
    .btn-white:hover { background: #E8F0FF; transform: translateY(-1px); }

    .btn-outline {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
    }
    .btn-outline:hover { background: rgba(255,255,255,0.18); transform: translateY(-1px); }

    /* ‚îÄ‚îÄ STATS GRID ‚îÄ‚îÄ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 18px;
      margin-bottom: 28px;
    }

    .stat-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 22px 24px;
      animation: slideUp 0.5s ease forwards;
      backdrop-filter: blur(10px);
    }

    .stat-card:nth-child(2) { animation-delay: 0.1s; opacity: 0; }
    .stat-card:nth-child(3) { animation-delay: 0.2s; opacity: 0; }

    .stat-icon { font-size: 22px; margin-bottom: 14px; }
    .stat-value {
      font-family: 'Playfair Display', serif;
      font-size: 26px;
      color: var(--white);
      margin-bottom: 4px;
    }
    .stat-label { font-size: 13px; color: var(--muted); }

    /* ‚îÄ‚îÄ BOTTOM GRID ‚îÄ‚îÄ */
    .bottom-grid {
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 20px;
    }

    /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(4px);
      z-index: 200;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.open { display: flex; }

    .modal {
      background: #0A1E4A;
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 36px;
      width: 420px;
      animation: modalIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes modalIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    .modal h3 {
      font-family: 'Playfair Display', serif;
      font-size: 22px;
      color: var(--white);
      margin-bottom: 6px;
    }

    .modal-sub { font-size: 13px; color: var(--muted); margin-bottom: 24px; }

    .modal label { display: block; font-size: 12px; font-weight: 600; color: #7A90B0; text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 8px; }

    .modal input, .modal select {
      width: 100%; background: rgba(255,255,255,0.04); border: 1px solid var(--border);
      border-radius: 10px; padding: 12px 16px; font-family: 'DM Sans', sans-serif;
      font-size: 14px; color: var(--white); outline: none; margin-bottom: 18px;
      transition: border-color 0.2s;
    }

    .modal input:focus { border-color: var(--accent); }
    .modal select option { background: #0A1E4A; }

    .modal-actions { display: flex; gap: 12px; margin-top: 8px; }

    .btn-cancel {
      flex: 1; padding: 12px; background: rgba(255,255,255,0.05);
      border: 1px solid var(--border); border-radius: 10px;
      color: var(--text); font-family: 'DM Sans', sans-serif;
      font-size: 14px; cursor: pointer; transition: all 0.2s;
    }
    .btn-cancel:hover { background: rgba(255,255,255,0.1); }

    .btn-confirm {
      flex: 2; padding: 12px;
      background: linear-gradient(135deg, var(--blue), #2563EB);
      border: none; border-radius: 10px; color: white;
      font-family: 'DM Sans', sans-serif; font-size: 14px;
      font-weight: 600; cursor: pointer; transition: all 0.2s;
    }
    .btn-confirm:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(37,99,235,0.3); }

    /* SECTION CARD */
    .section-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
    }

    .section-head {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--white);
    }

    .view-all {
      font-size: 13px; color: var(--accent);
      text-decoration: none; cursor: pointer;
    }

    /* TRANSACTIONS */
    .txn-list { padding: 8px 0; }

    .txn-item {
      display: flex;
      align-items: center;
      padding: 14px 24px;
      gap: 14px;
      transition: background 0.15s;
      cursor: default;
    }
    .txn-item:hover { background: rgba(59,130,246,0.05); }

    .txn-icon {
      width: 40px; height: 40px;
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }

    .txn-icon.credit { background: rgba(34,197,94,0.1); }
    .txn-icon.debit { background: rgba(239,68,68,0.1); }
    .txn-icon.flagged { background: rgba(245,158,11,0.15); }

    .txn-info { flex: 1; min-width: 0; }
    .txn-desc { font-size: 14px; font-weight: 500; color: var(--white); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .txn-date { font-size: 12px; color: var(--muted); margin-top: 2px; }

    .txn-amount {
      font-size: 15px; font-weight: 600;
      text-align: right;
    }
    .txn-amount.credit { color: var(--success); }
    .txn-amount.debit { color: var(--error); }

    .txn-flag {
      font-size: 10px; color: #F59E0B;
      background: rgba(245,158,11,0.1);
      padding: 2px 6px; border-radius: 4px;
      margin-top: 3px;
    }

    /* ACCESS REQUESTS PANEL */
    .access-panel { padding: 16px; display: flex; flex-direction: column; gap: 12px; }

    .access-card {
      background: rgba(6,17,42,0.7);
      border: 1px solid rgba(245,158,11,0.2);
      border-radius: 12px;
      padding: 16px;
    }

    .access-admin { font-size: 14px; font-weight: 600; color: var(--white); margin-bottom: 4px; }
    .access-reason { font-size: 13px; color: var(--muted); margin-bottom: 12px; line-height: 1.5; }

    .access-btns { display: flex; gap: 8px; }

    .btn-grant {
      flex: 1; padding: 9px; background: rgba(34,197,94,0.1);
      border: 1px solid rgba(34,197,94,0.3); border-radius: 8px;
      color: var(--success); font-size: 13px; font-weight: 600;
      cursor: pointer; transition: all 0.2s;
    }
    .btn-grant:hover { background: rgba(34,197,94,0.2); }

    .btn-deny {
      flex: 1; padding: 9px; background: rgba(239,68,68,0.08);
      border: 1px solid rgba(239,68,68,0.25); border-radius: 8px;
      color: var(--error); font-size: 13px; font-weight: 600;
      cursor: pointer; transition: all 0.2s;
    }
    .btn-deny:hover { background: rgba(239,68,68,0.15); }

    .empty-state { padding: 40px 24px; text-align: center; color: var(--muted); font-size: 14px; }

    .toast {
      position: fixed; top: 24px; right: 24px;
      padding: 14px 20px; border-radius: 10px;
      font-size: 14px; font-weight: 500; z-index: 999;
      transform: translateX(120%);
      transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .toast.show { transform: translateX(0); }
    .toast.success { background: #052E16; border: 1px solid #166534; color: #86EFAC; }
    .toast.error { background: #2A0A0A; border: 1px solid #7F1D1D; color: #FCA5A5; }

    /* Quick actions */
    .quick-grid {
      display: grid; grid-template-columns: 1fr 1fr;
      gap: 10px; padding: 16px;
    }

    .quick-btn {
      display: flex; flex-direction: column; align-items: center;
      gap: 8px; padding: 18px 10px;
      background: rgba(6,17,42,0.6); border: 1px solid var(--border);
      border-radius: 12px; cursor: pointer; transition: all 0.2s;
      color: var(--text); font-size: 13px; font-weight: 500;
    }
    .quick-btn:hover { background: rgba(59,130,246,0.1); border-color: var(--accent); color: var(--white); transform: translateY(-2px); }
    .quick-icon { font-size: 22px; }
  </style>
</head>
<body>

<div class="toast" id="toast"></div>

<!-- Modals -->
<div class="modal-overlay" id="loanModal">
  <div class="modal">
    <h3>üè∑Ô∏è Loan Eligibility Check</h3>
    <p class="modal-sub">Our AI will predict your eligibility instantly based on your account history.</p>
    <label>Requested Loan Amount (‚Çπ)</label>
    <input type="number" id="loan-amount" placeholder="e.g., 50000" min="1000"/>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal('loanModal')">Cancel</button>
      <button class="btn-confirm" onclick="doLoanCheck()">Check Eligibility</button>
    </div>
    <div id="loanResult" style="display:none; margin-top:18px; padding:16px; border-radius:10px;"></div>
  </div>
</div>

<div class="modal-overlay" id="depositModal">
  <div class="modal">
    <h3>üí∞ Deposit Money</h3>
    <p class="modal-sub">Add funds to your account</p>
    <label>Amount (‚Çπ)</label>
    <input type="number" id="deposit-amount" placeholder="Enter amount" min="1"/>
    <label>Description</label>
    <input type="text" id="deposit-desc" placeholder="e.g., Salary credit"/>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal('depositModal')">Cancel</button>
      <button class="btn-confirm" onclick="doDeposit()">Deposit</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="withdrawModal">
  <div class="modal">
    <h3>üì§ Withdraw Money</h3>
    <p class="modal-sub">Withdraw from your account</p>
    <label>Amount (‚Çπ)</label>
    <input type="number" id="withdraw-amount" placeholder="Enter amount" min="1"/>
    <label>Description</label>
    <input type="text" id="withdraw-desc" placeholder="e.g., ATM withdrawal"/>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal('withdrawModal')">Cancel</button>
      <button class="btn-confirm" onclick="doWithdraw()">Withdraw</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="transferModal">
  <div class="modal">
    <h3>‚ÜóÔ∏è Transfer Money</h3>
    <p class="modal-sub">Send money to another account</p>
    <label>Recipient Account Number</label>
    <input type="text" id="transfer-account" placeholder="e.g., ACC1234567890"/>
    <label>Amount (‚Çπ)</label>
    <input type="number" id="transfer-amount" placeholder="Enter amount" min="1"/>
    <label>Description</label>
    <input type="text" id="transfer-desc" placeholder="e.g., Rent payment"/>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal('transferModal')">Cancel</button>
      <button class="btn-confirm" onclick="doTransfer()">Send Money</button>
    </div>
  </div>
</div>

<!-- Sidebar -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <div class="logo-icon">üè¶</div>
    <span class="logo-name">SecureBank</span>
  </div>
  <nav class="sidebar-nav">
    <div class="nav-section-label">Main</div>
    <a class="nav-item active" href="/dashboard"><span class="nav-icon">üè†</span> Dashboard</a>
    <a class="nav-item" href="/transactions"><span class="nav-icon">üìã</span> Transactions</a>
    <div class="nav-section-label">Tools</div>
    <div class="nav-item" onclick="showModal('depositModal')"><span class="nav-icon">üí∞</span> Deposit</div>
    <div class="nav-item" onclick="showModal('withdrawModal')"><span class="nav-icon">üì§</span> Withdraw</div>
    <div class="nav-item" onclick="showModal('transferModal')"><span class="nav-icon">‚ÜóÔ∏è</span> Transfer</div>
    <div class="nav-section-label">AI Features</div>
    <div class="nav-item" onclick="checkCreditScore()"><span class="nav-icon">üìä</span> Credit Score</div>
    <div class="nav-item" onclick="checkLoan()"><span class="nav-icon">üè∑Ô∏è</span> Loan Eligibility</div>
  </nav>
  <div class="sidebar-user">
    <div class="user-avatar" id="avatarLetter">R</div>
    <div class="user-info">
      <div class="user-name" id="sidebarName">Loading...</div>
      <div class="user-role">Account Holder</div>
    </div>
    <button class="logout-btn" onclick="logout()" title="Logout">‚èª</button>
  </div>
</aside>

<!-- Main -->
<main class="main">
  <div class="topbar">
    <div class="page-title" id="greeting">Good morning üëã</div>
    <div class="topbar-right">
      <div class="alert-badge" id="alertBadge" onclick="loadAccessRequests()" style="display:none">
        <div class="badge-dot"></div>
        <span id="alertCount">0</span> access request(s)
      </div>
    </div>
  </div>

  <div class="content">
    <!-- Balance Card -->
    <div class="balance-card">
      <div class="balance-top">
        <div>
          <div class="balance-label">Available Balance</div>
          <div class="balance-amount">‚Çπ<span id="balance">‚Äì</span></div>
          <div class="balance-sub" id="balanceSub">Loading account details...</div>
        </div>
        <div style="text-align:right; position:relative; z-index:1;">
          <div style="font-size:12px; color:rgba(248,250,255,0.5); margin-bottom:4px;">Status</div>
          <div style="font-size:14px; color:#86EFAC; font-weight:600;">‚óè Active</div>
        </div>
      </div>
      <div class="acct-number" id="acctNumber">ACC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>
      <div class="balance-actions">
        <button class="btn-action btn-white" onclick="showModal('depositModal')">+ Deposit</button>
        <button class="btn-action btn-outline" onclick="showModal('withdrawModal')">Withdraw</button>
        <button class="btn-action btn-outline" onclick="showModal('transferModal')">‚Üó Transfer</button>
      </div>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">üìà</div>
        <div class="stat-value" id="totalCredits">‚Çπ‚Äì</div>
        <div class="stat-label">Total Credits (All Time)</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üìâ</div>
        <div class="stat-value" id="totalDebits">‚Çπ‚Äì</div>
        <div class="stat-label">Total Debits (All Time)</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üî¢</div>
        <div class="stat-value" id="txnCount">‚Äì</div>
        <div class="stat-label">Total Transactions</div>
      </div>
    </div>

    <!-- Bottom Grid -->
    <div class="bottom-grid">
      <!-- Recent transactions -->
      <div class="section-card">
        <div class="section-head">
          <span class="section-title">Recent Transactions</span>
          <a class="view-all" href="/transactions">View all ‚Üí</a>
        </div>
        <div class="txn-list" id="recentTxns">
          <div class="empty-state">Loading...</div>
        </div>
      </div>

      <!-- Right column -->
      <div style="display:flex; flex-direction:column; gap:20px;">
        <!-- Access Requests -->
        <div class="section-card">
          <div class="section-head">
            <span class="section-title">‚ö†Ô∏è Access Requests</span>
            <span style="font-size:12px; color:var(--muted);">From admins</span>
          </div>
          <div class="access-panel" id="accessPanel">
            <div class="empty-state">No pending requests</div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="section-card">
          <div class="section-head"><span class="section-title">Quick Actions</span></div>
          <div class="quick-grid">
            <div class="quick-btn" onclick="showModal('depositModal')"><div class="quick-icon">üí∞</div>Deposit</div>
            <div class="quick-btn" onclick="showModal('withdrawModal')"><div class="quick-icon">üì§</div>Withdraw</div>
            <div class="quick-btn" onclick="showModal('transferModal')"><div class="quick-icon">‚ÜóÔ∏è</div>Transfer</div>
            <div class="quick-btn" onclick="checkCreditScore()"><div class="quick-icon">üìä</div>Credit Score</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
  const API = window.location.origin + '/api/v1';
  const token = localStorage.getItem('token');
  if (!token) window.location.href = '/login';

  const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` };

  function showToast(msg, type = 'success') {
    const t = document.getElementById('toast');
    t.textContent = (type === 'success' ? '‚úÖ ' : '‚ùå ') + msg;
    t.className = `toast ${type} show`;
    setTimeout(() => t.classList.remove('show'), 3500);
  }

  function showModal(id) { document.getElementById(id).classList.add('open'); }
  function closeModal(id) { document.getElementById(id).classList.remove('open'); }

  document.querySelectorAll('.modal-overlay').forEach(m => {
    m.addEventListener('click', e => { if (e.target === m) m.classList.remove('open'); });
  });

  function formatCurrency(n) {
    return Number(n).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  function formatDate(d) {
    return new Date(d).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
  }

  function logout() {
    localStorage.clear();
    window.location.href = '/login';
  }

  // Set greeting
  const hour = new Date().getHours();
  document.getElementById('greeting').textContent =
    (hour < 12 ? 'Good morning üåÖ' : hour < 18 ? 'Good afternoon ‚òÄÔ∏è' : 'Good evening üåô');

  async function loadDashboard() {
    try {
      const res = await fetch(`${API}/user/dashboard`, { headers });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error);

      const u = data.account;
      document.getElementById('balance').textContent = formatCurrency(u.balance);
      document.getElementById('balanceSub').textContent = `Account holder ¬∑ ${u.email}`;
      document.getElementById('acctNumber').textContent = u.account_number.replace(/(.{3})/g, '$1 ').trim();
      document.getElementById('sidebarName').textContent = u.name;
      document.getElementById('avatarLetter').textContent = u.name[0].toUpperCase();

      // Stats from transactions
      const txns = data.recent_transactions;
      let credits = 0, debits = 0;
      txns.forEach(t => {
        if (t.type === 'credit') credits += t.amount;
        else debits += t.amount;
      });
      document.getElementById('totalCredits').textContent = '‚Çπ' + formatCurrency(credits);
      document.getElementById('totalDebits').textContent = '‚Çπ' + formatCurrency(debits);
      document.getElementById('txnCount').textContent = txns.length;

      // Render recent transactions
      renderTransactions(txns);

      // Access requests alert
      if (data.pending_access_requests > 0) {
        document.getElementById('alertBadge').style.display = 'flex';
        document.getElementById('alertCount').textContent = data.pending_access_requests;
        loadAccessRequests();
      }
    } catch(e) {
      showToast('Failed to load dashboard', 'error');
    }
  }

  function renderTransactions(txns) {
    const el = document.getElementById('recentTxns');
    if (!txns.length) { el.innerHTML = '<div class="empty-state">No transactions yet</div>'; return; }

    el.innerHTML = txns.slice(0, 6).map(t => {
      const isCredit = t.type === 'credit';
      const flagged = t.is_flagged;
      const icon = isCredit ? 'üì•' : flagged ? '‚ö†Ô∏è' : 'üì§';
      const cls = isCredit ? 'credit' : flagged ? 'flagged' : 'debit';
      return `
        <div class="txn-item">
          <div class="txn-icon ${cls}">${icon}</div>
          <div class="txn-info">
            <div class="txn-desc">${t.description || (isCredit ? 'Credit' : 'Debit')}</div>
            <div class="txn-date">${formatDate(t.timestamp)}</div>
            ${flagged ? '<div class="txn-flag">‚ö† Fraud Flagged</div>' : ''}
          </div>
          <div class="txn-amount ${isCredit ? 'credit' : 'debit'}">
            ${isCredit ? '+' : '-'}‚Çπ${formatCurrency(t.amount)}
          </div>
        </div>`;
    }).join('');
  }

  async function loadAccessRequests() {
    try {
      const res = await fetch(`${API}/user/access-requests`, { headers });
      const data = await res.json();
      const panel = document.getElementById('accessPanel');

      if (!data.access_requests.length) {
        panel.innerHTML = '<div class="empty-state">‚úÖ No pending access requests</div>';
        return;
      }

      panel.innerHTML = data.access_requests.map(r => `
        <div class="access-card">
          <div class="access-admin">üë§ ${r.admin_name}</div>
          <div class="access-reason">"${r.reason}"</div>
          <div class="access-btns">
            <button class="btn-grant" onclick="respondToRequest('${r.request_id}', 'grant')">‚úÖ Grant</button>
            <button class="btn-deny" onclick="respondToRequest('${r.request_id}', 'deny')">‚ùå Deny</button>
          </div>
        </div>`).join('');
    } catch(e) { /* silent */ }
  }

  async function respondToRequest(reqId, action) {
    try {
      const endpoint = action === 'grant' ? 'grant-access' : 'deny-access';
      const res = await fetch(`${API}/user/${endpoint}/${reqId}`, { method: 'POST', headers });
      const data = await res.json();
      showToast(res.ok ? data.message : data.error, res.ok ? 'success' : 'error');
      if (res.ok) { loadAccessRequests(); loadDashboard(); }
    } catch(e) {
      showToast('Failed to respond', 'error');
    }
  }

  async function doDeposit() {
    const amount = parseFloat(document.getElementById('deposit-amount').value);
    const description = document.getElementById('deposit-desc').value || 'Deposit';
    if (!amount || amount <= 0) { showToast('Enter valid amount', 'error'); return; }
    try {
      const res = await fetch(`${API}/user/deposit`, {
        method: 'POST', headers,
        body: JSON.stringify({ amount, description })
      });
      const data = await res.json();
      if (res.ok) {
        showToast(`‚Çπ${formatCurrency(amount)} deposited!`);
        closeModal('depositModal');
        loadDashboard();
      } else {
        showToast(data.error, 'error');
      }
    } catch(e) { showToast('Request failed', 'error'); }
  }

  async function doWithdraw() {
    const amount = parseFloat(document.getElementById('withdraw-amount').value);
    const description = document.getElementById('withdraw-desc').value || 'Withdrawal';
    if (!amount || amount <= 0) { showToast('Enter valid amount', 'error'); return; }
    try {
      const res = await fetch(`${API}/user/withdraw`, {
        method: 'POST', headers,
        body: JSON.stringify({ amount, description })
      });
      const data = await res.json();
      if (res.ok) {
        showToast(data.warning ? `‚ö†Ô∏è ${data.warning}` : `‚Çπ${formatCurrency(amount)} withdrawn!`, data.warning ? 'error' : 'success');
        closeModal('withdrawModal');
        loadDashboard();
      } else {
        showToast(data.error, 'error');
      }
    } catch(e) { showToast('Request failed', 'error'); }
  }

  async function doTransfer() {
    const to_account_number = document.getElementById('transfer-account').value.trim();
    const amount = parseFloat(document.getElementById('transfer-amount').value);
    const description = document.getElementById('transfer-desc').value || 'Transfer';
    if (!to_account_number || !amount || amount <= 0) { showToast('Fill all fields', 'error'); return; }
    try {
      const res = await fetch(`${API}/user/transfer`, {
        method: 'POST', headers,
        body: JSON.stringify({ to_account_number, amount, description })
      });
      const data = await res.json();
      if (res.ok) {
        showToast(`‚Çπ${formatCurrency(amount)} sent to ${data.to}!`);
        closeModal('transferModal');
        loadDashboard();
      } else {
        showToast(data.error, 'error');
      }
    } catch(e) { showToast('Request failed', 'error'); }
  }

  async function checkCreditScore() {
    try {
      const res = await fetch(`${API}/ml/credit-score`, { headers });
      const data = await res.json();
      const colors = { Excellent: '#22C55E', Good: '#3B82F6', Fair: '#F59E0B', Poor: '#EF4444' };
      showToast(`Credit Score: ${data.credit_score} ‚Äî ${data.rating}`, 'success');
    } catch(e) { showToast('Failed to load credit score', 'error'); }
  }

  function checkLoan() {
    document.getElementById('loan-amount').value = '';
    document.getElementById('loanResult').style.display = 'none';
    showModal('loanModal');
  }

  async function doLoanCheck() {
    const amount = parseFloat(document.getElementById('loan-amount').value);
    if (!amount || amount < 1000) { showToast('Enter a valid amount (min ‚Çπ1000)', 'error'); return; }

    const btn = document.querySelector('#loanModal .btn-confirm');
    btn.textContent = 'Checking...';
    btn.disabled = true;

    try {
      const res = await fetch(`${API}/ml/loan-eligibility`, {
        method: 'POST', headers,
        body: JSON.stringify({ requested_amount: amount })
      });
      const data = await res.json();

      const resultEl = document.getElementById('loanResult');
      resultEl.style.display = 'block';

      const eligible = data.eligible;
      const score = data.eligibility_score || 0;
      const scoreColor = score >= 70 ? '#22C55E' : score >= 40 ? '#F59E0B' : '#EF4444';

      resultEl.style.background = eligible ? 'rgba(34,197,94,0.08)' : 'rgba(239,68,68,0.08)';
      resultEl.style.border = eligible ? '1px solid rgba(34,197,94,0.25)' : '1px solid rgba(239,68,68,0.25)';

      resultEl.innerHTML = `
        <div style="display:flex; align-items:center; gap:12px; margin-bottom:14px;">
          <span style="font-size:28px;">${eligible ? '‚úÖ' : '‚ùå'}</span>
          <div>
            <div style="font-size:16px; font-weight:700; color:${eligible ? '#22C55E' : '#EF4444'};">
              ${eligible ? 'Eligible for Loan!' : 'Not Eligible'}
            </div>
            <div style="font-size:13px; color:var(--muted);">${data.recommendation}</div>
          </div>
        </div>
        <div style="margin-bottom:10px;">
          <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:6px;">
            <span style="color:var(--muted);">Eligibility Score</span>
            <span style="color:${scoreColor}; font-weight:700;">${score}/100</span>
          </div>
          <div style="height:8px; background:rgba(255,255,255,0.07); border-radius:4px; overflow:hidden;">
            <div style="height:100%; width:${score}%; background:${scoreColor}; border-radius:4px; transition:width 0.6s;"></div>
          </div>
        </div>
        ${data.reasons && data.reasons.length ? `
          <div style="font-size:12px; color:var(--muted); margin-top:10px;">
            ${data.reasons.map(r => `<div style="margin-bottom:4px;">‚Ä¢ ${r}</div>`).join('')}
          </div>` : ''}
        <div style="font-size:11px; color:#3D5070; margin-top:10px; font-style:italic;">
          Requested: ‚Çπ${Number(amount).toLocaleString('en-IN')} ¬∑ Confidence: ${Math.round((data.confidence || 0) * 100)}%
        </div>`;
    } catch(e) {
      showToast('Failed to check eligibility', 'error');
    } finally {
      btn.textContent = 'Check Eligibility';
      btn.disabled = false;
    }
  }

  loadDashboard();
</script>
</body>
</html>
